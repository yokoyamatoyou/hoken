# Jules向け指示書

## 保険特化型AIアシスタント開発仕様

---

## 0. プロジェクト概要 (Project Overview)

このプロジェクトの目的は、既存のPythonリポジトリを基盤とし、保険の専門家（代理店、営業、査定担当者など）の業務を支援する、高度なデスクトップAIアシスタントを開発することです。GPT-4.1世代の長文コンテキスト能力を最大限に活用し、複雑な保険文書の読解、分析、比較、レポート生成を直感的なGUIで実現します。

- **アプリケーション名:** Insurance AI Assistant

### 主要技術スタック

| 項目         | 内容                                       |
| ---------- | ---------------------------------------- |
| 言語         | Python 3.10+                             |
| UIフレームワーク  | CustomTkinter (既存リポジトリを踏襲)               |
| LLM        | OpenAI API (GPT-4.1-Turbo, GPT-4.1-mini) |
| 文書解析       | unstructured                             |
| チャンキング/RAG | LangChain                                |
| ベクトル化      | Sentence-Transformers                    |
| ベクトルストア    | FAISS (ローカル)                             |

---

## 1. GUIデザインとレイアウト (GUI Design & Layout)

### 1.1. 全体レイアウトと配色

- **テーマ:** Darkモード
- **配色:**
  - ベース: ダークグレー `#242424`
  - メインパネル: やや明るいグレー `#2D2D2D`
  - アクセントカラー: 青 `#3A7EBF`
  - テキスト: 白に近いグレー `#F0F0F0`
- **フォント:** Yu Gothic UI または Meiryo UI（日本語可読性重視）
- **アイコン:** Font Awesome等を活用（例: 📄, ➕, 📤）

---

### 1.2. 3ペイン構成の詳細

| [A] プロジェクト・ドキュメント管理    | [B] メインチャット & 分析パネル | [C] アウトプット & 可視化パネル  |
| ---------------------- | ------------------- | -------------------- |
| 1. プロジェクト選択 (ドロップダウン)  | 1. チャット履歴表示エリア      | 1. 生成コンテンツ・プレビュー     |
| - 新規プロジェクト作成...        | (ユーザーとAIの対話)        | (レポート、FAQ、チャート)      |
|                        |                     |                      |
| 2. 読み込み済みドキュメントリスト     |                     | 2. メタデータ表示エリア        |
| - 📄 約款.pdf (処理済)      |                     | - 引用元: 約款.pdf (p.15) |
| - 📄 設計書.xlsx (処理中...) |                     | - 関連条文: 第XX条...      |
|                        |                     |                      |
| 3. ドキュメント追加ボタン (+)     | 2. ユーザー入力ボックス       | 3. エクスポートボタン群        |
| (D&Dエリアを兼ねる)           | (プロンプト入力)           | - 📤 Word形式で保存       |
|                        |                     | - 📤 PDF形式で保存        |
|                        | 3. 送信ボタン / 生成停止ボタン  |                      |

---

### 1.3. 各コンポーネントの仕様

#### [A] プロジェクト・ドキュメント管理パネル

- **プロジェクト選択:** ドロップダウンで切替。「新規プロジェクト作成」で新しいベクトルストア作成。
- **ドキュメントリスト:** 文書一覧とステータス表示（処理中/処理済/エラー）。
- **ドキュメント追加:** ファイル選択ダイアログ兼D&Dエリア。

#### [B] メインチャット & 分析パネル

- **チャット履歴:** ユーザー・AI対話履歴をスクロール表示。AI回答はMarkdownで表示。
- **ユーザー入力:** CTkTextboxによる複数行入力。Enter送信、Shift+Enter改行。

#### [C] アウトプット & 可視化パネル

- **プレビュー:** 生成レポートやFAQ等をプレビュー。
- **メタデータ表示:** 参照元情報リスト化。リストクリックでチャットハイライト推奨。
- **エクスポート:** Word, PDF等で保存。

---

## 2. バックエンドアーキテクチャ (Backend Architecture)

### 2.1. 文書処理パイプライン (RAG Pipeline)

#### 文書読み込み (Loader)

- `unstructured`ライブラリを利用しPDF, Word, Excel, 画像(PNG, JPG)等からテキスト・レイアウト抽出
- `UnstructuredFileLoader`中心に実装

#### チャンキング (Chunking)

- `LangChain`の`RecursiveCharacterTextSplitter`を使用
- separators: `["\n\n", "\n", "。", "、", ""]` + 正規表現（例: `r'第\d+条'`）で日本語構造維持
- チャンクサイズ: 1000、オーバーラップ: 100（デフォルト）

#### ベクトル化 & 保存 (Embedding & Storage)

- Embeddingモデル: `sentence-transformers/all-MiniLM-L6-v2` もしくは `distiluse-base-multilingual-cased-v1`
- ベクトルストア: FAISS
- プロジェクトごとにローカル保存（`index.faiss`, `index.pkl`）

---

### 2.2. チャット応答プロセス

#### リトリーバル (Retrieval)

- 質問文をEmbedding
- FAISSで類似度検索（上位5〜10チャンク取得）

#### プロンプト生成 (Prompt Engineering)

```
あなたは優秀な保険アナリストです。以下のコンテキスト情報とユーザーの質問に基づき、正確かつ分かりやすく回答してください。回答を生成する際は、どのコンテキスト情報を参照したかを明確に示してください。

# コンテキスト情報
---
[コンテキスト1: {文書名}, p.{ページ番号}]
{チャンク1のテキスト}
---
[コンテキスト2: {文書名}, p.{ページ番号}]
{チャンク2のテキスト}
---
...

# ユーザーの質問
{ユーザーの質問文}

# 回答
```

#### LLM推論 (Inference)

- OpenAI API (model: gpt-4.1-turbo) にプロンプト送信
- レスポンスはストリーミングで受信・リアルタイム表示

---

### 2.3. アウトプット生成機能

- **レポート/FAQ生成:** チャット履歴を要約・分析レポート作成指示でLLM活用。右ペインにMarkdownでプレビュー。
- **ファイルエクスポート:** pypandoc等でWord/PDF変換して保存

---

## 3. 既存コードの活用とリファクタリング方針

- **src/ui/agent\_app.py**

  - CustomTkinterの基本構造を流用し、新レイアウトに刷新
  - 「Agent選択」等は廃止、左ペイン「プロジェクト管理」機能へ置換

- **src/agent/**

  - react\_agent.py, cot\_agent.py, tot\_agent.pyは不要
  - 新たに `src/rag_agent.py` を実装し、agent\_app.py から呼び出す構造に

- **src/tools/**

  - web\_scraper, sqlite\_toolは不要
  - 新たに `src/document_processor.py` を実装し文書処理パイプライン担当

- **requirements.txt**

  - 追加/更新:
    ```
    customtkinter
    openai
    langchain
    langchain-community
    unstructured[all-docs]
    sentence-transformers
    faiss-cpu
    pypandoc
    ```

---

## 4. 開発の進め方 (推奨ステップ)

1. **GUIの骨格作成**

   - agent\_app.py をリファクタ。新3ペインレイアウトと主要ウィジェットを仮実装

2. **文書処理パイプラインの実装**

   - document\_processor.py を新規作成。GUIと独立しファイル処理の検証

3. **GUIと文書処理の統合**

   - 「ドキュメント追加」等の操作で document\_processor 実行・処理状況表示

4. **RAGチャット機能の実装**

   - rag\_agent.py でプロンプト生成・LLM問合せ・ストリーミング応答までを実装

5. **アウトプット機能の実装**

   - レポート生成・エクスポート機能と右ペイン連携

---

以上の指示に基づき、保険特化型AIアシスタントの開発を開始してください。

---

ご希望により「見やすく分割」や「英訳」などの追加編集も可能です。必要に応じてお申し付けください。

